<html>
  <head>
    <title>Defend</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <style type="text/css">body{background-color: #FFF;margin: 0px;overflow: hidden; }</style>
  <link href='http://fonts.googleapis.com/css?family=VT323' rel='stylesheet' type='text/css'>
    <script type="text/javascript" language="JavaScript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-8977675-12']);
      _gaq.push(['_trackPageview']);
      (function() {
	var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body style='background:#333'  onkeydown='keyIsDown(event)' onkeyup='keyIsUp(event)'  >
    <div id="canvasContainer" style="width:100%;">
      <canvas id="canvas"></canvas>
    </div>
  <script>
    var ctx = document.getElementById('canvas').getContext('2d');
    var f=1;
    var img = new Image();  
    var imgEnnemy = new Image();
    var imgMissile = new Image();    
    var angel= new Image();
    var basher= new Image();
    var blocker= new Image();
    var boarder= new Image();
    var bomber= new Image();
    var bridger= new Image();
    var bridger_walk= new Image();
    var climber= new Image();
    var digger= new Image();
    var drownfall= new Image();
    var drownwalk= new Image();
    var exit= new Image();
    var explo= new Image();
    var faller= new Image();
    var floater= new Image();
    var miner= new Image();
    var rocketlauncher= new Image();
    var slider= new Image();
    var splat= new Image();
    var superman= new Image();
    var tumble= new Image();
    var waiter= new Image();
    var walker= new Image();
    var doorImg = new Image();

    /*** LISTS ***/
    var lemmings = new Array();
    var elements = new Array();
    /*** MAIN STRUCTURES (mouse, kb & main character) ***/
    var cursor = {
      x : 0,
      y : 0,
      oldX : 0,
      oldY : 0,
      buttonLeft : 0,
      buttonRight : 0
    }
    var keyBoard = {
    }
   
    var door = {x:300,y:270 }
   
    /*** MAIN OBJECTS (Ennemies, explosions & missiles) ***/
    /*************** Lemming ! ****************/
    function Lemming(x,y){
      this.direction = 0;
      this.oldDirection = 0;
      this.x=x;
      this.y=y;
      this.energy = 100;
      this.speed = 0;
      this.reqFrame=0;
      //============ move() =================
      this.move = function(){	
	ctx.drawImage(walker,(64) + 32 * ((this.reqFrame) % 6) , 0 , 32, 32, this.x, this.y, 32, 32);
	// Get image data
	var imageData = ctx.getImageData(this.x + (Math.abs(this.direction)) * 32, this.y + 32, 5, 1);
	if ((imageData.data[0] != 1 && imageData.data[1] !=  1 && imageData.data[2] !=  1 ) && this.y < canvas.height-32 && this.direction != -1){
	  this.oldDirection = this.direction;
	  console.log(this.direction);
	  this.direction = -1;
	}
	else if (this.direction < 0 && imageData.data[0] == 1 && imageData.data[1] ==  1 && imageData.data[2] ==  1){
	  this.direction = this.oldDirection;
	  console.log(this.direction);
	}
	else{
	  imageData = ctx.getImageData(this.x+(Math.abs(this.direction))*27, this.y+31, 5, 1);
	  if ((imageData.data[0] == 1 && imageData.data[1] ==  1 && imageData.data[2] ==  1 ) ){
	    if ((imageData.data[0] == 1 && imageData.data[1] ==  1 && imageData.data[2] ==  1 ) ){
	      this.y-=1;
	    }
	  }
	}
	if (this.direction < 0){
	  this.y += 0.0+this.speed;
	  this.speed+=0.2;
	}
	else if (this.direction == 0){
	 this.x += 1;
	 this.speed=0;
	 if (Math.floor(this.x) > canvas.width-40){
	    this.direction=1
	    console.log(this.direction);
	  }
	}
	else{
	  this.x -= 1;
	 this.speed=0;
	  if (this.x < 0){
	    this.direction=0;
	    console.log(this.direction);
	  }
	}
      }
    }
    function Element(x,y){
      this.x=x;
      this.y=y;
    }

    /**** MUF ****/
    function addElement(x,y){		
      var found = false;
      for (var i = 0 ; i < elements.length ; i++){
	if (elements[i].x == x && elements[i].y == y){
	  found = true;
	  break;
	}
      }
      if (!found)
	elements.push(new Element(x,y));
    }
    /*** MOUSE CONTROL ***/
    canvas.onmousemove = function(e)
    {
      var mouseX, mouseY;
      cursor.oldX = cursor.x;
      cursor.oldY = cursor.y;
      if(e.offsetX) {
	cursor.x = e.offsetX;
	cursor.y= e.offsetY;
      }
      else if(e.layerX) {
	cursor.x = e.layerX;
	cursor.y = e.layerY;
      }
      if (cursor.buttonLeft || cursor.buttonRight)
	addElement(cursor.x,cursor.y);	
    }
    canvas.onmousedown = function(e)
    {
      if (e.button == 0)
	cursor.buttonLeft=1;
      else if (e.button == 1)
	cursor.buttonRight=1;
    }
    canvas.onmouseup = function(e)
    {
      if (e.button == 0)
	cursor.buttonLeft=0;
      else if (e.button == 1)
	cursor.buttonRight=0;
    }
    /*** KEYBOARD CONTROL ***/
    function keyIsDown(event)
    {
    }
    function keyIsUp(event)
    {
    }
    function input()
    {
    } 
    /*** utility function ***/
    Array.prototype.remove = function(from, to) {
      var rest = this.slice((to || from) + 1 || this.length);
      this.length = from < 0 ? this.length + from : from;
      return this.push.apply(this, rest);
    };
    /**** HERE ARE THE MAIN RENDER FUNCTIONS => DURING GAME & GAMEOVER, TODO: welcome page ***/
    function update(){
      //let's clear this
      ctx.fillStyle = 'rgb(255,255,255)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = 'rgb(1,1,1)';
      ctx.fillRect(0,100,600,10);
      ctx.fillRect(200,200,canvas.width-200,10);
      ctx.fillRect(100,400,700,10);
      ctx.fillRect(200,500,600,10);
      ctx.fillRect(0,700,800,10);
      ctx.drawImage(doorImg,door.x,door.y);
      for (var i = 0 ; i < elements.length ; i++){
	ctx.fillRect(elements[i].x,elements[i].y,10,2);
      }
      for (i=0;i<lemmings.length;i++){
	if (f%5==0)
	  lemmings[i].reqFrame+=1;
	if (lemmings[i].direction > 0){
	  lemmings[i].move();
	}
	else if (lemmings[i].direction == 0){
	  lemmings[i].move();
	}
	else if (lemmings[i].speed < 3){
		if (lemmings[i].oldDirection > 0){
		  lemmings[i].move();
		}
		else if (lemmings[i].oldDirection == 0){
		  lemmings[i].move();
		}	
	}
	else{
		  lemmings[i].move();
	}
      }
      for (var i = 0 ; i < lemmings.length ; i++){
	if (lemmings[i].x < cursor.x && lemmings[i].x + 32 > cursor.x 
	    && lemmings[i].y < cursor.y && lemmings[i].y + 32 > cursor.y)
	console.log("found:"+i);
      }
      if (f%60==0){
	if (lemmings.length < 6)
	  lemmings.push(new Lemming(0,50));
      }
    }
    window.requestAnimFrame = 	( 
      function(){
	return  window.requestAnimationFrame || 
	window.webkitRequestAnimationFrame || 
	window.mozRequestAnimationFrame    || 
	window.oRequestAnimationFrame      || 
	window.msRequestAnimationFrame     || 
	function(callback, element)
	{
	  window.setTimeout(callback, 1000 / 60);
	};
      }
    )();
    function run(){
      input();
      update();
      requestAnimFrame(run);
      f++;
    }
    function init() {
      ctx.canvas.width  = window.innerWidth;
      ctx.canvas.height  = window.innerHeight;
      doorImg.src = 'src/th_SuperMario64Door.jpg';
      angel.src = "src/angel.png"
      basher.src = "src/basher.png"
      blocker.src = "src/blocker.png"
      boarder.src = "src/boarder.png"
      bomber.src = "src/bomber.png"
      bridger.src = "src/bridger.png"
      bridger_walk.src = "src/bridger_walk.png"
      climber.src = "src/climber.png"
      digger.src = "src/digger.png"
      drownfall.src = "src/drownfall.png"
      drownwalk.src = "src/drownwalk.png"
      exit.src = "src/exit.png"
      explo.src = "src/explo.png"
      faller.src = "src/faller.png"
      floater.src = "src/floater.png"
      miner.src = "src/miner.png"
      rocketlauncher.src = "src/rocketlauncher.png"
      slider.src = "src/slider.png"
      splat.src = "src/splat.png"
      superman.src = "src/superman.png"
      tumble.src = "src/tumble.png"
      waiter.src = "src/waiter.png"
      walker.src = "src/walker.png"
    }
    init();
    run();
  </script>
</body>
</html>
