
<html>
  <head>
    <title>Pingus</title>
    <style type="text/css">body{ margin: 0px; padding: 0px; }</style>
    <link href='http://fonts.googleapis.com/css?family=Mountains+of+Christmas' rel='stylesheet' type='text/css'>
  </head>
  <body style="background-image:url('src/background.jpg')">
  <canvas id="canvas"></canvas>
  <script>
    var ctx = document.getElementById('canvas').getContext('2d');
    var f=1;
    var selectedCapacity = "";
    var game = { lemmingsSaved: 0 , lemmingsProduced : 0, lemmingsToProduced : 1, lemmingsDead : 0};
    var lemmingsImages = {
      walker : new Image(),
      faller : new Image(),
      floater  : new Image(),
      splat  : new Image(),
      slider  : new Image(),
      basher  : new Image(),
      blocker  : new Image(),
      boarder  : new Image(),
      bomber  : new Image(),
      bridger  : new Image(),
      bridger_walk  : new Image(),
      climber  : new Image(),
      digger  : new Image(),
      drownfall  : new Image(),
      drownwalk  : new Image(),
      exit  : new Image(),
      miner  : new Image(),
      superman  : new Image(),
      tumble  : new Image(),
      waiter  : new Image(),
    };
    var img = new Image() , imgSnowBlock = new Image(), imgWater = new Image(), doorImg = new Image();
    
   /*** LISTS ***/
    var lemmings = [];
    var elements = [];
    var tiles = [];
    /*** MAIN STRUCTURES (mouse, kb & main character) ***/
    var keyBoard = {};
    var cursor = {
      x : 0,
      y : 0,
      oldX : 0,
      oldY : 0,
      buttonLeft : 0,
      buttonRight : 0
    }
    /*** MAIN OBJECTS (Ennemies, explosions & missiles) ***/
    /*************** dig elements ****************/
    function Element(x,y){
      this.x=x;
      this.y=y;
    }

    /*************** Lemming ! ****************/
    function Lemming(x,y){
      this.direction = -1;
      this.previousDirection = 0;
      this.state = 0;
      this.x = x;
      this.y = y - 12;
      this.speed = 0;
      this.frame = 0;
      this.countFrame = 0;
      this.job = [];
      this.drown = false;
      this.blocking = false;
      this.exiting = false;
      this.bomber = false;
      this.miner = false;
      this.capacities = { build : 2 , floater: 2};
      //===========================================================
      //====		 walk or fall function			===
      //===========================================================
      this.live = function(){	
	//==========================
	// behaviour management
	//==========================
	var imageData = ctx.getImageData(this.x + 15, this.y + 32 + ~~(this.speed), 1, 1).data;
	var digging = false;
	for (var i = 0 ; i < this.job.length ; i++){
	  if (this.job[i] == "digger"){
	    digging = true;
	  }
	  else if (this.job[i] == "blocker" && this.direction != -1){
	    this.blocking = true;
	  }
	  else if (this.job[i] == "bridger" && this.direction != -1){
	    this.bridger = true;
	  }
	  else if (this.job[i] == "bomber" && this.direction != -1){
	    this.bomber = true;
	  }
	  else if (this.job[i] == "miner" && this.direction != -1){
	    this.miner = true;
	  }
	}
	if (this.bomber){
	}
	else if (this.exiting){
	}
	else if (this.bridger){
	  var tilePosition = !this.direction ? this.x + 30 : this.x - 6;
	  tiles.push( new Element(tilePosition , this.y + 30));
	  this.countFrame+=1;
	  if (this.countFrame % 280 == 0 ){
	    this.bridger = false;
	    for (var i = 0; i < this.job.length ; i++){
		if (this.job[i] == "bridger")
		  this.job.splice(i,1);
		i--;
	    }
	  }
	}
	else if (this.blocking){
	}
	else if (this.drown){
	}
	else if (this.miner){
	  var imageDataMiner = ctx.getImageData(this.x +15, this.y + 33 , 1, 1).data;
	  if ((imageDataMiner[0] == 255 || imageDataMiner[1] == 255 || imageDataMiner[2] == 255) && imageDataMiner[3] == 255){
	    this.direction = this.previousDirection;
	    for (var i = 0 ; i < this.job.length ; i++){
	      if (this.job[i] == "miner"){
		  this.job.splice(i,1);
		  i--;
	      }
	    }
	  }
	  else{
	    if (this.frame % 12 == 0){
	      this.y += 1;
	      this.x += this.direction ? -2 : 2;
	    }
	    ctx.drawImage(lemmingsImages.miner,(64) + 32 * ((this.frame) % 6) , this.direction ? 0 : 32 , 32, 32, this.x, this.y + 1, 32, 32);
	    elements.push(new Element(this.x + 33, this.y + 33));
	  }
	}
	else if (digging){
	  if (imageData[8] + imageData[9] + imageData[10] == 0){
	    digging = false;
	    this.direction = -1;
	    for (var i = 0 ; i < this.job.length ; i++){
	      if (this.job[i] == "digger"){
		  this.job.splice(i,1);
		  i--;
	      }
	    }
	  }
	  else{
	    this.y += 1;
	    ctx.drawImage(lemmingsImages.digger,(64) + 32 * ((this.frame) % 6) , 0 , 32, 32, this.x, this.y + 1, 32, 32);
	    elements.push(new Element(this.x, this.y + 33));
	  }
	}
	//are we falling?
	if (this.direction == -1 && !this.blocking && !this.drown && !this.bridger && !this.exiting && !this.bomber && !this.miner ){
	  //we check if we hit the floor
	  if (this.y < canvas.height - 69 && imageData[0] + imageData[1] + imageData[2] > 600){
	    //Lemming hits the floor and continues its walk
	    var canFloat = false;
	    for (var j = 0 ; j < this.job.length ; j++){
	      if (this.job[j] == "floater"){
		canFloat = true; 
	      }
	    }
	    if (this.speed > 2.8 && !canFloat)
	      this.state = -1;
	    this.direction = this.previousDirection;
	    this.y += 1;
	  }
	  else{
	    // Coordinates update
	    this.y += 0.0 + this.speed;
	    this.speed+=0.02;
	    if (this.y > canvas.height - 53)
	      this.drown = true;
	  }
	}
	//we check if the floor is still under
	else if ((imageData[0] + imageData[1] + imageData[2] < 600) && !this.bridger && !this.miner){
	  this.previousDirection = this.direction;  
	  this.direction = -1;
	}
	//going to the right
	else if (this.direction == 0 && !digging && !this.drown && !this.blocking && !this.bridger && !this.miner){
	 this.x += 2;
	 this.speed=0;
	 if (this.x > canvas.width-32){
	    this.direction = 1;
	  }
	}
	//to the left
	else if (!digging && !this.drown && !this.blocking && !this.bridger && !this.miner){
	 this.x -= 2;
	 this.speed = 0;
	  if (this.x < 0)
	    this.direction=0;
	}

	//=======================================================
	//Animations and coords update
	//=======================================================
	if (this.bridger){
	  ctx.drawImage(lemmingsImages.bridger,(64) + 32 * ((this.frame) % 6) , !this.direction ? 32 : 0 , 32, 32, this.x, this.y + 1, 32, 32);
	  if (f % 6 == 0 && this.frame % 6 == 0){
	    this.x += this.direction ? -10 : 10;
	    this.y -= 2;
	  }
	}
	else if (this.bomber){
	   ctx.drawImage(lemmingsImages.bomber,(64) + 32 * ((this.frame) % 12) , 0 , 32, 32, this.x, this.y + 1, 32, 32);
	}
	else if (this.exiting){
	  if (this.direction)
	    ctx.drawImage(lemmingsImages.exit,(64) + 32 * ((this.frame) % 4) , 0 , 32, 32, this.x, this.y + 1, 32, 32);
	  else
	    ctx.drawImage(lemmingsImages.exit,(64) + 32 * ((this.frame) % 4) , 32 , 32, 32, this.x, this.y + 1, 32, 32);
	}
	else if (this.blocking){
	  ctx.drawImage(lemmingsImages.blocker,(64) + 32 * ((this.frame) % 4) , 0 , 32, 32, this.x, this.y + 1, 32, 32);
	}
	else if (this.state != -1 && !digging && !this.drown && !this.miner){
	  if (this.direction >= 0){
	    for (var i = 0; i < lemmings.length ; i++){
	      var lemming = lemmings[i];
	      var mirror = this.direction ? 0 : 0;
	      if (lemming.blocking == true && 
		      this.x + mirror > lemming.x && this.x + mirror < lemming.x + 32 
		      && this.y + mirror > lemming.y && this.y < lemming.y  + 31){
		 this.direction = this.direction ? 0 : 1;
	      }
	    }
	    var imgData = ctx.getImageData(this.x + (this.direction ? 32 : -2), this.y + 30, 2,2);
	    if (imgData.data[0] == 2 && imgData.data[1] == 1 && imgData.data[2] == 2)
	      this.y -= 2;
	    ctx.putImageData(imgData,0,0);
	  }
	  //Ok so we're walking or falling
	  switch (this.direction){
	    // Rendering...
	    case 1: //right direction
	      ctx.drawImage(lemmingsImages.walker,(64) + 32 * ((this.frame) % 6) , 0 , 32, 32, this.x, this.y + 1, 32, 32);
	    break;
	    case 0: //left direction
	      ctx.drawImage(lemmingsImages.walker,(64) + 32 * ((this.frame) % 6) , 32, 32, 32, this.x, this.y + 1, 32, 32);
	    break;
	    default: //falling ( = -1 )
	      var floating = false;
	      if (this.speed > 2){
		for (var i = 0 ; i < this.job.length ; i++){
		  if (this.job[i] == "floater"){
		    floating = true;
		    //Floating
		    ctx.drawImage(lemmingsImages.floater,(64) + 32 * ((this.frame) % 6) , 0 , 32, 32, this.x, this.y + 1, 32, 32);
		    break;
		  }
		}
	      }
	      //falling
	      if (!floating){
		ctx.drawImage(lemmingsImages.faller,(64) + 32 * ((this.frame) % 6) , 0 , 32, 32, this.x, this.y + 1, 32, 32);
	      }
	    break;
	  }
	}
	//splat
	else if (!digging && !this.drown && !this.miner){
	  ctx.drawImage(lemmingsImages.splat,(64) + 32 * ((this.frame) % 6) , 0 , 32, 32, this.x, this.y + 1, 32, 32);	
	}
	//gloups
	else if (!digging && this.drown && !this.miner){
	  ctx.drawImage(lemmingsImages.drownfall,(64) + 32 * ((this.frame) % 6) , 0 , 32, 32, this.x, this.y + 1, 32, 32);	
	  this.y += 0.3;
	  this.countFrame+=1;
	  if (this.countFrame > 15)
	  {
	      this.state = -2;
	  }
	}
	if ( f % 7 == 0 )
	  this.frame+=1; //animation	
      }
    }
    var door = { x: 300, y: 310 }
   
    /*** MOUSE CONTROL ***/
    canvas.onmousemove = function(e)
    {
      var mouseX, mouseY;
      cursor.oldX = cursor.x;
      cursor.oldY = cursor.y;
      if(e.offsetX) {
	cursor.x = e.offsetX;
	cursor.y= e.offsetY;
      }
      else if(e.layerX) {
	cursor.x = e.layerX;
	cursor.y = e.layerY;
      }	
    }
    canvas.onmousedown = function(e)
    {
      if (e.button == 0)
	cursor.buttonLeft=1;
      else if (e.button == 1)
	cursor.buttonRight=1;
    }
    canvas.onmouseup = function(e)
    {
      if (e.button == 0)
	cursor.buttonLeft=0;
      else if (e.button == 1)
	cursor.buttonRight=0; 
    }
    /*** KEYBOARD CONTROL ***/
    function keyIsDown(event)
    {
    }
    function keyIsUp(event)
    {
    }
    function input()
    {
    } 
    /*** utility function TODO: too old is too old, remove!***/
    Array.prototype.move = function(from, to) {
      var rest = this.slice((to || from) + 1 || this.length);
      this.length = from < 0 ? this.length + from : from;
      return this.push.apply(this, rest);
    };
    /**** HERE ARE THE MAIN FUNCTIONS ***/
    function update(){
      //let's clear this
      ctx.fillStyle = 'rgb(255,255,255)';
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(lemmingsImages.basher, 0, 0, 32,32, canvas.width - 32 * 2, 0, 32, 32);
      ctx.drawImage(lemmingsImages.blocker, 0, 0, 32,32, canvas.width - 32 * 3, 0, 32, 32);
      ctx.drawImage(lemmingsImages.miner, 0, 0, 32,32, canvas.width - 32 * 4, 0, 32, 32);
      ctx.drawImage(lemmingsImages.bomber, 384, 0, 32,32, canvas.width - 32 * 5, 0, 32, 32);
      ctx.drawImage(lemmingsImages.bridger, 0, 0, 32,32, canvas.width - 32 * 6, 0, 32, 32);
      ctx.drawImage(lemmingsImages.climber, 0, 0, 32,32, canvas.width - 32 * 7, 0, 32, 32);
      ctx.drawImage(lemmingsImages.digger, 0, 0, 32,32, canvas.width - 32 * 8, 0, 32, 32);
      ctx.drawImage(lemmingsImages.floater, 0, 0, 32, 32, canvas.width - 32 * 9, 0, 32, 32);
      
      ctx.fillStyle = 'rgb(1,1,1)';
      if (cursor.y < 32 && cursor.x > canvas.width - 32 * 9){
	var rest = Math.round((canvas.width - cursor.x) / 32) ;
	if (cursor.buttonLeft){
	  switch (rest){
	  case 1:
	  break;
	  case 2:
	    selectedCapacity = "digger";
	  break;
	  case 3:
	    selectedCapacity = "blocker";
	  break;
	  case 4:
	    selectedCapacity = "miner";
	  break;
	  case 5:
	    selectedCapacity = "bomber";
	  break;
	  case 6:
	    selectedCapacity = "bridger";
	  break;
	  case 7:
	    selectedCapacity = "climber";
	  break;
	  case 8:
	    selectedCapacity = "digger";
	  break;
	  case 9:
	    selectedCapacity = "floater";
	  break;
	  }
	}
	ctx.strokeStyle = "rgba(199,0,0,0.9)";
	ctx.strokeRect(canvas.width - rest * 32, 0,32,32);
	ctx.stroke();
      }
      for (var i = 0 ; i < 600 ; i+=90){
	ctx.drawImage(imgSnowBlock, i, 100);
      }
      for (var i = 0 ; 200 + i  < canvas.width ; i+=90){
	ctx.drawImage(imgSnowBlock,200 + i, 200);
      }
      for (var i = 0 ; i  < 600 ; i += 90){
	ctx.drawImage(imgSnowBlock, i, 400);
      }
      for (var i = 0 ; i  < canvas.width ; i += 512){
	ctx.drawImage(imgWater, i, canvas.height - 32);
      }
      ctx.drawImage(doorImg,door.x,door.y);
      ctx.fillStyle = "rgba(255, 255, 255,1)";
      for (var i = 0 ; i < elements.length ; i++){
	ctx.clearRect(elements[i].x,elements[i].y - 3,32,4);
      }
      ctx.fillStyle = "rgba(2,1,2,1)";
      for (var i = 0 ; i < tiles.length ; i++){
	ctx.fillRect(tiles[i].x,tiles[i].y , 15, 6);
      }
      
      // Now let's loop on the lemming list
      for (var i = 0 ; i < lemmings.length ; i++){
	var lemming = lemmings[i];
	//is he in front of the door???
	if (lemming.x > 310 && lemming.x < 350 && lemming.y > 270 && lemming.y < 380){
	  lemming.exiting = true;
	  lemming.countFrame++;
	  if (lemming.countFrame == 6){
	    lemmings.splice(i,1);
	    game.lemmingsSaved++;
	  }
	}
	else if (lemming.bomber){
	  lemming.countFrame++;
	  if (lemming.countFrame == 12){
	    lemmings.splice(i,1);
	    game.lemmingsDead++;
	  }
	}
	//does the cursor is upon the mouse?
	if (lemming.x < cursor.x && lemming.x + 32 > cursor.x 
	    && lemming.y < cursor.y && lemming.y + 32 > cursor.y){
	  ctx.strokeStyle = "rgba(199,0,0,0.7)";
	  ctx.strokeRect(lemming.x + 2, lemming.y + 2 , 28, 28);
	  ctx.stroke();
	  if (cursor.buttonLeft){
		lemming.job.push(selectedCapacity);
	  }
	}
	lemming.live();
	if (lemming.state == -2){
	  lemmings.splice(i,1);
	}
      }
      if (game.lemmingsProduced < game.lemmingsToProduced && f % 40 == 0){
	  lemmings.push(new Lemming(0,50));
	  game.lemmingsProduced++;
      }
      ctx.font = "bold 22px 'Mountains of Christmas'";
      ctx.fillText("Pingus: "+game.lemmingsProduced+"/"+game.lemmingsToProduced,canvas.width - 150,60);
      ctx.fillText("Saved pingus: "+game.lemmingsSaved,canvas.width - 150,85);
      ctx.fillText("Lost pingus: "+game.lemmingsDead,canvas.width - 150,110);
      if (game.lemmingsSaved + game.lemmingsDead == game.lemmingsToProduced){
	ctx.font = "bold 35px 'Mountains of Christmas'";
	ctx.fillStyle = "rgb(255,255,255)";
	ctx.fillRect(canvas.width / 2 - 50, canvas.height / 2 - 15);
	ctx.fillStyle = "rgb(255,0,0)";
	ctx.fillText("Game over",canvas.width / 2 - 30,canvas.height / 2 - 30);
	ctx.fillText("Lemmings saved:" + game.lemmingsSaved + "/" + game.lemmingsToProduced,canvas.width / 2 - 60,canvas.height / 2 + 13);
      
      }
    }
    window.requestAnimFrame = 	( 
      function(){
	return  window.requestAnimationFrame || 
	window.webkitRequestAnimationFrame || 
	window.mozRequestAnimationFrame    || 
	window.oRequestAnimationFrame      || 
	window.msRequestAnimationFrame     || 	
	function(callback, element){
	  window.setTimeout(callback, 1000 / 300);
	};
      }
    )();
    function run(){
      input();
      update();
      requestAnimFrame(run);
      f++;
    }
    function init() {
      ctx.canvas.width  = window.innerWidth;
      ctx.canvas.height  = window.innerHeight;
      doorImg.src = 'src/exitSnow.png';
      imgWater.src = "src/water.png";
      imgSnowBlock.src = "src/snowBlock.png"
      lemmingsImages.walker.src = "src/walker.png"
      lemmingsImages.faller.src = "src/faller.png"
      lemmingsImages.splat.src = "src/splat.png";
      lemmingsImages.floater.src = "src/floater.png";
      lemmingsImages.slider.src = "src/slider.png";
      lemmingsImages.basher.src = "src/basher.png";
      lemmingsImages.blocker.src = "src/blocker.png";
      lemmingsImages.boarder.src = "src/boarder.png";
      lemmingsImages.bomber.src = "src/bomber.png";
      lemmingsImages.bridger.src = "src/bridger.png";
      lemmingsImages.bridger_walk.src = "src/bridger_walk.png";
      lemmingsImages.climber.src = "src/climber.png";
      lemmingsImages.digger.src = "src/digger.png";
      lemmingsImages.drownfall.src = "src/drownfall.png";
      lemmingsImages.drownwalk.src = "src/drownwalk.png";
      lemmingsImages.exit.src = "src/exit.png";
      lemmingsImages.miner.src = "src/miner.png";
      lemmingsImages.slider.src = "src/slider.png";
      lemmingsImages.superman.src = "src/superman.png";
      lemmingsImages.tumble.src = "src/tumble.png";
      lemmingsImages.waiter.src = "src/waiter.png";
    }
    init();
    run();
  </script>
</body>
</html>