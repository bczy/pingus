<html>
  <head>
    <title>Defend</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <style type="text/css">body{background-color: #FFF;margin: 0px;overflow: hidden; }</style>
  <link href='http://fonts.googleapis.com/css?family=VT323' rel='stylesheet' type='text/css'>
    <script type="text/javascript" language="JavaScript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-8977675-12']);
      _gaq.push(['_trackPageview']);
      (function() {
	var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body style='background:#333'  onkeydown='keyIsDown(event)' onkeyup='keyIsUp(event)'  >
    <div id="canvasContainer" style="width:100%;">
      <canvas id="canvas"></canvas>
    </div>
  <script>
    var ctx = document.getElementById('canvas').getContext('2d');
    var f=1;
    var bRed=0;var bGreen=0;var bBlue=0;
    var rSpiral = 0
    var life=100;
    var firePower=100;
    var decalSpiral = 0;
    var distArc=0;
    var espaceEnnemy=250;
    var scoreShoot=100;
    var score=0;
    var highScoreShoot=0;
    var gameOverFrame=0;
    var userHighScore = 0;
    var img = new Image();  
    var imgEnnemy = new Image();
    var imgMissile = new Image();    
    var angel= new Image();
    var basher= new Image();
    var blocker= new Image();
    var boarder= new Image();
    var bomber= new Image();
    var bridger= new Image();
    var bridger_walk= new Image();
    var climber= new Image();
    var digger= new Image();
    var drownfall= new Image();
    var drownwalk= new Image();
    var exit= new Image();
    var explo= new Image();
    var faller= new Image();
    var floater= new Image();
    var miner= new Image();
    var rocketlauncher= new Image();
    var slider= new Image();
    var splat= new Image();
    var superman= new Image();
    var tumble= new Image();
    var waiter= new Image();
    var walker= new Image();
    var doorImg = new Image();

    var x = 50;
    var y = canvas.height / 2;
    var inertieX = 0 ; var inertieY = 0;
    var bomb=0;
    var nbBomb=3;
    var reqFrame=0;
    var nbEnnemKilled=0;
    var nbEnnemyWave=1;
    var ennemyCountDown=240;
    /*** LISTS ***/
    var lemmings = new Array();
    var missiles  = new Array();
    var explosions = new Array();
    var elements = new Array();
    /*** MAIN STRUCTURES (mouse, kb & main character) ***/
    var cursor = {
      x : 0,
      y : 0,
      oldX : 0,
      oldY : 0,
      buttonLeft : 0,
      buttonRight : 0
    }
    var keyBoard = {
      left : 0,
      right :0,
      top :0,
      bottom :0,
      fire : 0,
      spiral : 0,
      explode : 0
    }
    var me = {
      direction : 1.5,
      energy : 100,
      fire : 0
    }
   
    var door = {x:300,y:270 }
   
    /*** MAIN OBJECTS (Ennemies, explosions & missiles) ***/
    function Lemming(x,y){
      this.direction = 0;
      this.oldDirection = 0;
      this.x=x;
      this.y=y;
      this.energy = 100;
      this.speed = 0;
      this.reqFrame=0;
      this.move = function(){	
	// Get image data
	var imageData = ctx.getImageData(this.x+(Math.abs(this.direction))*32, this.y+32, 50, 1);
	if ((imageData.data[0] != 1 && imageData.data[1] !=  1 && imageData.data[2] !=  1 ) && this.y < canvas.height-32 && this.direction != -1){
	  this.oldDirection = this.direction;
	  this.direction = -1;
	  if (f%250==0) console.log(imageData);
	}
	else if (this.direction < 0 && imageData.data[0] == 1 && imageData.data[1] ==  1 && imageData.data[2] ==  1){
	  this.direction = this.oldDirection
	}
	else{
	  imageData = ctx.getImageData(this.x+(Math.abs(this.direction))*27, this.y+31, 32, 1);
	  if ((imageData.data[0] == 1 && imageData.data[1] ==  1 && imageData.data[2] ==  1 ) ){
	    this.y-=1;
	  }
	}
	if (this.direction < 0){
	  this.y += 0.0+this.speed;
	  this.speed+=0.2;
	}
	else if (this.direction == 0){
	 this.x += 1;
	 this.speed=0;
	 if (Math.floor(this.x) > canvas.width-40)
	  this.direction=1
	}
	else{
	  this.x -= 1;
	 this.speed=0;
	  if (this.x < 0)
	    this.direction=0
	}
	ctx.putImageData(imageData, 0, 0);
      }
    }
    function Bonus(x,y){
      this.x=x;
      this.y=y;
      var roulette = Math.random() * 2;
      if (roulette < 1)
	this.type="L";
      else if (roulette < 2)
	this.type="A";
      else
	this.type="B";
      console.log("type:"+this.type);
    }
    function Missile(){
      this.direction = me.direction;
      this.x=-1;
      this.y=-1;
      this.energy = 100;
      this.direction = 0;
      this.move = function(){	
	this.x += 5;
	this.y += (this.direction - 1.5  )*8;
      }
    }
    function Element(x,y){
      this.x=x;
      this.y=y;
    }
    function Explosion (x,y) {
	this.x=x;
	this.y=y;
	this.dx= 5 - (Math.random() * 10);
	this.dy= 5 - (Math.random() * 10); 
	this.speed = 1 + Math.random()*5;
	this.lifeTime = 50;
	this.red = 255
    }

    /**** MUF ****/
    function removeElement(x,y){		
      var found = false;
      for (i = 0 ; i < elements.length ; i++){
	if (elements[i].x == x && elements[i].y == y){
	  elements.remove(i);
	  break;
	}
      }
    }
    function addElement(x,y){		
      var found = false;
      for (i = 0 ; i < elements.length ; i++){
	if (elements[i].x == x && elements[i].y == y){
	  found = true;
	  break;
	}
      }
      if (!found)
	elements.push(new Element(x,y));
    }
    /*** MOUSE CONTROL ***/
    canvas.onmousemove = function(e)
    {
      var mouseX, mouseY;
      cursor.oldX = cursor.x;
      cursor.oldY = cursor.y;
      if(e.offsetX) {
	cursor.x = e.offsetX;
	cursor.y= e.offsetY;
      }
      else if(e.layerX) {
	cursor.x = e.layerX;
	cursor.y = e.layerY;
      }
      console.log(cursor.x+" "+cursor.y);
      if (cursor.buttonLeft)
	addElement(cursor.x,cursor.y);
      if (cursor.buttonRight)
	removeElement(cursor.x,cursor.y);
    }
    canvas.onmousedown = function(e)
    {
      if (e.button == 0)
	cursor.buttonLeft=1;
      else if (e.button == 1)
	cursor.buttonRight=1;
    }
    canvas.onmouseup = function(e)
    {
      if (e.button == 0)
	cursor.buttonLeft=0;
      else if (e.button == 1)
	cursor.buttonRight=0;
    }
    /*** KEYBOARD CONTROL ***/
    function keyIsDown(event)
    {
      if(event.keyCode == 17)
      {
	keyBoard.fire = 1;
      }
      if(event.keyCode == 32)
      {
	keyBoard.bomb = 1;
      }
      if(event.keyCode == 38)
      {
	keyBoard.top = 1;
      }
      if(event.keyCode == 40)
      {
	keyBoard.bottom = 1;
      }
      if(event.keyCode == 37)
      {
	keyBoard.left = 1;
      }
      if(event.keyCode == 39)
      {
	keyBoard.right = 1;
      }
    }
    function keyIsUp(event)
    {
      if(event.keyCode == 17)
      {
	keyBoard.fire = 0;
      }
      if(event.keyCode == 38)
      {
	keyBoard.top = 0;
      }
      if(event.keyCode == 40)
      {
	keyBoard.bottom = 0;
      }
      if(event.keyCode == 37)
      {
	keyBoard.left = 0;
      }
      if(event.keyCode == 39)
      {
	keyBoard.right = 0;
      }
    }
    function input()
    {
      if (keyBoard.fire  == 0 && firePower < 100)
	firePower+=0.4;
      if (keyBoard.fire == 1 && Math.floor(firePower) > 0)
	firePower-=0.9;
      if (keyBoard.left){
	if (me.direction > 0.1)
	  me.direction-=0.05;
      }
      if (keyBoard.right){
	if (me.direction < 2.9)
	  me.direction+=0.05;
      }
      
      
      if (keyBoard.bottom>0 && y<canvas.height - 50)
	inertieX=inertieX+0.5;
      if (keyBoard.top>0 && y > 50)
	inertieX=inertieX-0.5;

      if (inertieX>0)
	inertieX-=0.15;
      else if (inertieX<0)
	inertieX+=0.15;
      
      y += inertieX + (y<canvas.height?keyBoard.bottom:0) - (y>0?keyBoard.top:0);
      if (y>canvas.height - 30)
	y=canvas.height- 30;
      if (y<90)
	y=90;
    } 
    /*** utility function ***/
    Array.prototype.remove = function(from, to) {
      var rest = this.slice((to || from) + 1 || this.length);
      this.length = from < 0 ? this.length + from : from;
      return this.push.apply(this, rest);
    };
    /**** HERE ARE THE MAIN RENDER FUNCTIONS => DURING GAME & GAMEOVER, TODO: welcome page ***/
    function gameOver(){
      for(var i= 0 ; i < explosions.length ; i++){
	ctx.beginPath(); 
	explosions[i].x += explosions[i].dx * explosions[i].speed  ;
	explosions[i].y += explosions[i].dy * explosions[i].speed ;
	explosions[i].lifeTime = explosions[i].lifeTime -1;
	ctx.fillRect( explosions[i].x  , explosions[i].y, 1 , 1 );
	ctx.fill();
	ctx.closePath();	
	if (explosions[i].lifeTime == 0){
	  explosions.remove(i);
	  //console.log("muf: " + explosions.length + " " + forrest.length);
	}
      }
      ctx.fillStyle = 'rgba('+bRed+','+bGreen+','+bBlue+','+0.1+')';
      ctx.fillRect(0,0,10000, 10000);
      ctx.fillStyle = 'rgb(255,'+(255- (rSpiral*100) - (5-life) * 50)+','+(255- (rSpiral*100)- ((5-life) * 50))+')';
      ctx.fillText("GAME OVER!!!",canvas.width/2  -50, (canvas.height/2)-100 );
      ctx.fillText("Your score:"+score,canvas.width/2  -50, (canvas.height/2));
    }
    function update(){
      var width = 32;
      var height = 32;
      //let's clear this
      ctx.fillStyle = 'rgb(255,255,255)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = 'rgb(1,1,1)';
      ctx.fillRect(0,100,600,10);
      ctx.fillRect(200,200,canvas.width-200,10);
      ctx.fillRect(100,400,700,10);
      ctx.fillRect(200,500,600,10);
      ctx.fillRect(0,700,800,10);
      ctx.drawImage(doorImg,door.x,door.y);
	console.log(door.x + " " + door.y);
      for (i = 0 ; i < elements.length ; i++){
	ctx.fillRect(elements[i].x,elements[i].y,10,2);
      }
      for (i=0;i<lemmings.length;i++){
	if (f%5==0)
	  lemmings[i].reqFrame+=1;
	if (lemmings[i].direction > 0){
	  ctx.drawImage(walker, (width*2)+width*((lemmings[i].reqFrame)%6) , 0 , width  , height , lemmings[i].x , lemmings[i].y ,width,height);
	  lemmings[i].move();
	}
	else if (lemmings[i].direction == 0){
	  ctx.drawImage(walker, width*((lemmings[i].reqFrame)%7) , 32	 , width  , height , lemmings[i].x , lemmings[i].y ,width,height);
	  lemmings[i].move();
	}
	else if (lemmings[i].speed < 3){
		if (lemmings[i].oldDirection > 0){
		  ctx.drawImage(walker, (width*2)+width*((lemmings[i].reqFrame)%6) , 0 , width  , height , lemmings[i].x , lemmings[i].y ,width,height);
		  lemmings[i].move();
		}
		else if (lemmings[i].oldDirection == 0){
		  ctx.drawImage(walker, width*((lemmings[i].reqFrame)%7) , 32	 , width  , height , lemmings[i].x , lemmings[i].y ,width,height);
		  lemmings[i].move();
		}	
	}
	else{
		console.log(lemmings[i].speed);
		  ctx.drawImage(faller,(width)+width*((lemmings[i].reqFrame)%2) , 0 , width  , height , lemmings[i].x , lemmings[i].y ,width,height);
		  lemmings[i].move();
	}
      }
      for (i = 0 ; i < lemmings.length ; i++){
	if (lemmings[i].x < cursor.x && lemmings[i].x + 32 > cursor.x 
	    && lemmings[i].y < cursor.y && lemmings[i].y + 32 > cursor.y)
	console.log("found:"+i);
      }
      if (f%60==0){
	if (lemmings.length < 10)
	  lemmings.push(new Lemming(0,50));
      }
    }
    /*** WHO NEED THREADS ??? ***/
    window.requestAnimFrame = 	( 
      function(){
	return  window.requestAnimationFrame || 
	window.webkitRequestAnimationFrame || 
	window.mozRequestAnimationFrame    || 
	window.oRequestAnimationFrame      || 
	window.msRequestAnimationFrame     || 
	function(callback, element)
	{
	  window.setTimeout(callback, 1000 / 60);
	};
      }
    )();
    function run(){
      if (life <=0 )
      {
	    gameOver();
	    if (gameOverFrame == 0){
	      for (i=0;i < 500;i++)
		  explosions.push(new Explosion(50,canvas.height/2));
	      forrest= new Array();
	      if ( score > userHighScore){
		localStorage['defendMeScore'] = score;
		userHighScore = score;
	      }
	    }
	    gameOverFrame +=1;
      }
      else{
	input();
	update();
      }
      requestAnimFrame(run);
      f++;
    }
    function init() {
      ctx.strokeStyle = "rgb(255,255,255)";
      ctx.lineWidth = 5;
      ctx.canvas.width  = window.innerWidth;
      ctx.canvas.height  = window.innerHeight;
      ctx.font = "normal 42px VT323";
      if (localStorage['defendMeScore'])
	userHighScore = localStorage['defendMeScore'];
      else
	userHighScore  = 0;
      doorImg.src = 'src/th_SuperMario64Door.jpg';
      img.src = 'src/lemmings.png';
      imgEnnemy.src = 'src/2.png';
      imgMissile.src = 'src/missile.png';
      angel.src = "src/angel.png"
      basher.src = "src/basher.png"
      blocker.src = "src/blocker.png"
      boarder.src = "src/boarder.png"
      bomber.src = "src/bomber.png"
      bridger.src = "src/bridger.png"
      bridger_walk.src = "src/bridger_walk.png"
      climber.src = "src/climber.png"
      digger.src = "src/digger.png"
      drownfall.src = "src/drownfall.png"
      drownwalk.src = "src/drownwalk.png"
      exit.src = "src/exit.png"
      explo.src = "src/explo.png"
      faller.src = "src/faller.png"
      floater.src = "src/floater.png"
      miner.src = "src/miner.png"
      rocketlauncher.src = "src/rocketlauncher.png"
      slider.src = "src/slider.png"
      splat.src = "src/splat.png"
      superman.src = "src/superman.png"
      tumble.src = "src/tumble.png"
      waiter.src = "src/waiter.png"
      walker.src = "src/walker.png"
    }
    init();
    run();
  </script>
</body>
</html>
